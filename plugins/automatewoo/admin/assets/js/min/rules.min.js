!function(s,e){AW.Rules=Backbone.Model.extend({initialize:function(){var t=this,s=[];this.get("rawRuleOptions")&&_.each(this.get("rawRuleOptions"),function(e){var i=new AW.RuleGroup(t),l=[];_.each(e,function(e){var t=new AW.Rule(i);t.set("name",e.name),t.resetOptions(),t.set("compare",e.compare),t.set("value",e.value),e.selected&&t.set("selected",e.selected),l.push(t)}),i.set("rules",l),s.push(i)}),this.set("ruleOptions",s),this.resetAvailableRules()},defaults:function(){return{allRules:{},availableRules:{},ruleOptions:[]}},resetAvailableRules:function(){var t=AW.workflow.get("trigger");this.set("availableRules",_.filter(this.get("allRules"),function(e){return t&&-1!==t.supplied_data_items.indexOf(e.data_item)}));var i={};_.each(this.get("availableRules"),function(e){i[e.group]||(i[e.group]=[]),i[e.group].push(e)}),this.set("groupedRules",i)},isRuleAvailable:function(e){var t=AW.rules.get("availableRules"),i=_.pluck(t,"name");return-1!==_.indexOf(i,e)},clearIncompatibleRules:function(){var t=[];_.each(AW.rules.get("ruleOptions"),function(e){_.each(e.get("rules"),function(e){e&&!AW.rules.isRuleAvailable(e.get("name"))&&t.push(e)})}),_.each(t,function(e){e.clear()})},createGroup:function(){var e=this.get("ruleOptions"),t=new AW.RuleGroup(this);return t.createRule(),e.push(t),this.set("ruleOptions",e),this.trigger("ruleGroupChange"),t},removeGroup:function(e){var t=this.get("ruleOptions"),i=t.map(function(e){return e.id}).indexOf(e);t[i].destroy(),t.splice(i,1),this.set("ruleOptions",t),this.trigger("ruleGroupChange")}}),AW.Rule=Backbone.Model.extend({initialize:function(e){this.set("id",_.uniqueId("rule_")),this.set("group",e),this.resetOptions()},getRuleObject:function(){return e.allRules[this.get("name")]},resetOptions:function(){var e=this.get("name"),t=this.getRuleObject();return e?this.set("object",t):this.set("object",{}),this.set("compare",!1),this.set("value",!1),this.loadSelectOptions(),this},loadSelectOptions:function(){var t=this,i=this.getRuleObject();return!i||"select"!==i.type||i.select_choices||(t.set("isValueLoading",!0),s.getJSON(ajaxurl,{action:"aw_get_rule_select_choices",rule_name:i.name},function(e){e.success&&(i.select_choices=e.data.select_choices,t.set("isValueLoading",!1),t.set("object",i),t.trigger("optionsLoaded"))})),this},clear:function(){this.get("group").removeRule(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleGroup=Backbone.Model.extend({initialize:function(e){this.set("id",_.uniqueId("rule_group_")),this.set("app",e),this.set("rules",[])},createRule:function(){var e=this.get("rules"),t=new AW.Rule(this);return e.push(t),this.set("rules",e),t},removeRule:function(e){var t=this.get("rules"),i=t.map(function(e){return e.id}).indexOf(e);1<t.length?(t[i].destroy(),t.splice(i,1),this.set("rules",t)):(t[i].destroy(),this.clear())},clear:function(){this.get("app").removeGroup(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleView=Backbone.View.extend({className:"automatewoo-rule-container",template:wp.template("aw-rule"),events:{"change .js-rule-select":"updatedName","change .js-rule-compare-field":"updatedCompare","change .js-rule-value-field":"updatedValue","click .js-remove-rule":"clear","change .js-rule-value-from":"updateMinFromValueDate"},initialize:function(){this.listenTo(this.model,"change:id",this.render),this.listenTo(this.model,"change:group",this.render),this.listenTo(this.model,"optionsLoaded",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this;return e.$el.html(e.template({rule:e.model.toJSON(),groupedRules:AW.rules.get("groupedRules"),fieldNameBase:e.getFieldNameBase()})),e.setName(),e.setCompare(),e.setValue(),e.maybeToggleValueDisplay(),e.initDatepicker(),s(document.body).trigger("wc-enhanced-select-init"),this},setName:function(){this.$el.find(".js-rule-select").val(this.model.get("name"))},setCompare:function(){var e=this.$el.find(".js-rule-compare-field"),t=this.model.get("compare");if(e.filter("select").length&&!t){var i=e.find("option:first-child"),l=e.find("option:first-child").prop("value");i.prop("selected",!0),e.val(l),this.model.set("compare",l)}t&&(e.val(t),e.find('option[value~="'+t+'"]').prop("selected",!0))},setValue:function(){if(this.model.get("selected")){var e=this.$el.find(".js-rule-value-field");e.is("select")?e.append(s("<option>",{value:this.model.get("value"),text:this.model.get("selected")})):e.attr("data-selected",this.model.get("selected"))}if(this.model.get("value")){var t=this.$el.find(".js-rule-value-field"),i=this.model.get("value"),l=this;this.hasMultipleValueFields()?(_.isArray(i)&&t.each(function(e,t){s(t).val(i[e])}),_.isObject(i)&&Object.keys(i).forEach(function(e){s(".js-rule-value-"+e,l.$el).val(i[e])})):t.val(i)}},updatedName:function(e){this.model.set("name",e.target.value).resetOptions(),this.render()},updatedCompare:function(e){this.model.set("compare",e.target.value),this.render()},updatedValue:function(e){var t;this.hasMultipleValueFields()?(t=[],this.$el.find(".js-rule-value-field").each(function(){t.push(s(this).val())})):t=e.target.value,this.model.set("value",t)},getFieldNameBase:function(){var e=this.model.get("id");return"aw_workflow_data[rule_options]["+this.model.get("group").id+"]["+e+"]"},clear:function(){this.model.clear()},hasMultipleValueFields:function(){var e=this.model.get("object");return e&&e.has_multiple_value_fields},maybeToggleValueDisplay:function(){var e=this.model.get("compare"),t=this.$el.find("[data-aw-compare]");t.length&&(t.addClass("aw-hidden").prop("required",!1).find("select, input").prop("required",!1),t.filter('[data-aw-compare~="'+e+'"]').removeClass("aw-hidden").prop("required",!0).find("select, input").prop("required",!0))},initDatepicker:function(){this.$el.find(".js-date-picker").datepicker({dateFormat:"yy-mm-dd",showButtonPanel:!0})},updateMinFromValueDate:function(){var e=this.$el.find(".js-rule-value-from"),t=this.$el.find(".js-rule-value-to");e.length&&t.length&&t.datepicker("option","minDate",e.val())}}),AW.RuleGroupView=Backbone.View.extend({className:"aw-rule-group",template:wp.template("aw-rule-group"),events:{"click .js-add-rule":"addRule"},initialize:function(){this.listenTo(this.model,"refreshRules",this.refreshRules),this.listenTo(this.model,"change:id",this.refreshRules),this.listenTo(this.model,"destroy",this.remove)},render:function(){var i=this;return i.model.get("rules").length&&(i.$el.html(i.template(i.model.toJSON())),i.$el.find(".rules").empty(),_.each(i.model.get("rules"),function(e){var t=new AW.RuleView({model:e});i.$el.find(".rules").append(t.render().el)})),s(document.body).trigger("wc-enhanced-select-init"),this},addRule:function(){var e=this.model.createRule(),t=new AW.RuleView({model:e});return this.$el.find(".rules").append(t.render().el),s(document.body).trigger("wc-enhanced-select-init"),this},refreshRules:function(){_.each(this.model.get("rules"),function(e){e.trigger("change:group")})},clear:function(){this.undelegateEvents(),this.model.clear()}}),AW.RulesView=Backbone.View.extend({el:s("#aw-rules-container"),$meta_box:s("#aw_rules_box"),template:wp.template("aw-rules-container"),events:{"click .js-add-rule-group":"addGroup"},initialize:function(){this.listenTo(this.model,"ruleGroupChange",this.maybeShowEmptyMessage),this.listenTo(this.model,"change:groupedRules",this.refreshRules),this.render()},render:function(){var e=this,t=AW.workflow.get("trigger");e.$el.html(e.template({app:e,trigger:t}));var i=e.$el.find(".aw-rule-groups"),l=e.model.get("ruleOptions");return l.length?_.each(l,function(e){var t=new AW.RuleGroupView({model:e});i.append(t.render().el)}):this.addEmptyMessage(),s(document.body).trigger("wc-enhanced-select-init"),this},addGroup:function(){var e=this.model.createGroup(),t=new AW.RuleGroupView({model:e});return this.$el.find(".aw-rule-groups").append(t.render().el),s(document.body).trigger("wc-enhanced-select-init"),this},maybeShowEmptyMessage:function(){this.model.get("ruleOptions").length?this.removeEmptyMessage():this.addEmptyMessage()},addEmptyMessage:function(){this.$el.find(".aw-rule-groups").html(wp.template("aw-rule-groups-empty"))},removeEmptyMessage:function(){this.$el.find(".aw-rules-empty-message").remove()},refreshRules:function(){_.each(this.model.get("ruleOptions"),function(e){e.trigger("refreshRules")})}}),s(document).ready(function(){AW.rules=new AW.Rules({allRules:e.allRules,rawRuleOptions:e.ruleOptions}),AW.rulesView=new AW.RulesView({model:AW.rules})})}(jQuery,automatewooWorkflowLocalizeScript);
//# sourceMappingURL=rules.min.js.map
